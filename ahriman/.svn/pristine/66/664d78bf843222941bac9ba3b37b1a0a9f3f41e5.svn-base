package com.syhd.ahriman.service.impl;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cache.annotation.CacheConfig;
import org.springframework.cache.annotation.CacheEvict;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.stereotype.Service;

import com.syhd.ahriman.dao.mapper.DailyRevenueMapper;
import com.syhd.ahriman.dao.model.AppServer;
import com.syhd.ahriman.dao.model.DailyRevenue;
import com.syhd.ahriman.dto.ExchangeRate;
import com.syhd.ahriman.dto.KpiStatistic;
import com.syhd.ahriman.dto.RequestPayload;
import com.syhd.ahriman.dto.Result;
import com.syhd.ahriman.dto.StatisticPayload;
import com.syhd.ahriman.properties.GamelogProperties;
import com.syhd.ahriman.service.CronTask;
import com.syhd.ahriman.utils.DateUtils;

@Service
@CacheConfig(cacheNames="KpiAppraiseRevenue")
public class KpiAppraiseRevenueService {
	
	private static Logger logger = LoggerFactory.getLogger(KpiAppraiseRevenueService.class);
	
	@Autowired
	private GamelogProperties gamelogProperties;
	
	@Autowired
	private DailyRevenueMapper dailyRevenueMapper;
	
	@Autowired
	private ExchangeRateService exchangeRateService;
	
	@Autowired
	private AppServerService appServerService;

	/**
	 * 获取KPI考核收入
	 * @param param 查询参数
	 * @return 包含汇总数据
	 */
	public Result getDailyRevenue(RequestPayload param) {
		RequestPayload copy = RequestPayload.prepare(param,null,null);
		
		Result result = Result.getErrorResult();
		
		result = exchangeRateService.getExchangeRate();
		if(!Result.isSuccessResult(result)) {
			result.setMessage(result.getMessage());
			return result;
		}
		ExchangeRate rate = (ExchangeRate) result.getData();
		
		List<KpiStatistic> list = null;
		if(RequestPayload.containToday(copy)) {
			//查询期限包含今天
			doRealtimeStatistic();
			list = dailyRevenueMapper.getMixinStatistic(copy,rate);
		} else {
			//查询期限不包含今天
			list = dailyRevenueMapper.getStatistic(copy,rate);
		}
		list = KpiStatistic.fill(list, copy.getStart(), copy.getEnd());
		
		result = Result.getSuccessResult();
		StatisticPayload data = new StatisticPayload(list, RequestPayload.unPrepare(copy));
		result.setData(data);
		
		return result;
	}
	
	/**
	 * 查询实时数据，并放进临时表
	 */
	private void doRealtimeStatistic() {
		List<AppServer> serverList = appServerService.getAllServer();
		
		Date startDate = DateUtils.getTodayTime0();
		Calendar now = Calendar.getInstance();
		now.setTime(startDate);
		now.add(Calendar.DAY_OF_MONTH, 1);
		Date endDate = now.getTime();
		
		dailyRevenueMapper.createTodayRevenueTable();
		for(AppServer server : serverList) {
			doRevenueTask(startDate,endDate,server,"t_today_revenue");
		}
	}
	
	@Cacheable(key="#root.method")
	public List<DailyRevenue> getAllServer() {
		return dailyRevenueMapper.getAllServer();
	}
	
	@Cacheable(key="#root.method")
	public List<String> getAllPlatform() {
		return dailyRevenueMapper.getAllPlatform();
	}
	
	/*====================================分割线,以下方法非对外使用====================================*/
	
	@CronTask("0 0 0 * * ?")
	@CacheEvict(allEntries=true)
	public void task() {
		List<AppServer> serverList = appServerService.getAllServer();
		for(AppServer server : serverList) {
			revenueTask(server);
		}
	}
	
	/**
	 * 抓取每个日志服务器的收入信息
	 * @param server 游戏日志服务器信息
	 */
	public void revenueTask(AppServer server) {
		Date startDate = null;
		Date endDate = DateUtils.getTodayTime0();
		Date lastCountDate = dailyRevenueMapper.getLastCountDate(server.getServerid());
		if(lastCountDate == null) {
			startDate = new Date(0);
		} else {
			Calendar now = Calendar.getInstance();
			now.setTime(lastCountDate);
			now.add(Calendar.DAY_OF_MONTH, 1);
			startDate = now.getTime();
		}
		
		doRevenueTask(startDate, endDate, server, "t_daily_revenue");
	}
	
	private void doRevenueTask(Date startDate, Date endDate, AppServer server, String storedTable) {
		if(!startDate.before(endDate)) {
			// 如果开始日期没在结束日期之前，则不用处理
			return;
		}
		
		String url = appServerService.getLogDbUrl(server.getLogDb());
		String user = gamelogProperties.getUsername();
		String password = gamelogProperties.getPassword();
		try(Connection conn = DriverManager.getConnection(url, user, password)) {	
			PreparedStatement stmt = conn.prepareStatement(
					"select date,platform,moneyType,sum(money) money from " + 
					"(select date(date) date,platform,rmb money,vip moneyType from t_rechargelog where date >= ? and date < ?) t "+
					"group by date,platform,moneyType");
			stmt.setDate(1, DateUtils.conver2SqlDate(startDate));
			stmt.setDate(2, DateUtils.conver2SqlDate(endDate));
			
			ResultSet resultSet = stmt.executeQuery();
			final int batchSize = 100; // 每次批量插入的阈值
			List<DailyRevenue> revenueList = new ArrayList<>(batchSize*2);
			while(resultSet.next()) {
				Date date = resultSet.getDate(1);
				String platform = resultSet.getString(2);
				Integer moneyType = resultSet.getInt(3);
				Integer money = resultSet.getInt(4);

				DailyRevenue record = new DailyRevenue();
				record.setDate(date);
				record.setMoney(money);
				record.setMoneyType(moneyType);
				record.setPlatform(platform);
				record.setServerId(server.getServerid());
				record.setServerName(server.getServername());
				revenueList.add(record);
				
				if(revenueList.size() == batchSize) {
					dailyRevenueMapper.batchInsert(revenueList,storedTable);
					revenueList.clear();
				}
			}
			if(revenueList.size() > 0) {
				dailyRevenueMapper.batchInsert(revenueList,storedTable);
			}
		} catch (Exception e) {
			logger.error("日收入数据查询失败", e);
			throw new RuntimeException("日收入数据查询失败"); // 需要回滚事务
		}
	}
	
}
